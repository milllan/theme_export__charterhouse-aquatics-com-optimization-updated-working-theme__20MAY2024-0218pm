{%- comment -%}
************************************************************************
* NOTE: This file is generated by the Flair app and should not be modified.
*
* Any changes made to this file will be overwritten the next time you change
* your Flair settings.
*
* Supported options:
*
* collection      - the collection
* product         - the product
* flair_layout    - the layout name
* flair_page_type - the page type
* flair_variant   - the variant
*
* Flair: https://apps.shopify.com/flair
* Copyright Brainy Atom LLC, All Rights Reserved.
*
* Last updated: 2024-05-16T12:55:28Z
************************************************************************
{%- endcomment -%}
{%- liquid
assign flair_output = ""
assign flair_config = shop.metafields["flair-app"].config
assign flair_layout_config = blank
assign flair_layout_default = blank
if flair_page_type == blank
  assign flair_page_type = request.page_type
endif
for bp in flair_config.badge_layouts
  if bp.is_default
    assign flair_layout_default = bp
  endif
  if flair_layout != blank
    assign _flair_a = flair_layout | downcase
    assign _flair_b = bp.name | downcase
    if _flair_a == _flair_b
      assign flair_layout_config = bp
      break
    else
    endif
  elsif bp.page_types contains flair_page_type
    assign flair_layout_config = bp
    break
  endif
endfor

if flair_layout_config == blank
  assign flair_layout_config = flair_layout_default
endif

if flair_layout_config == blank
  assign flair_layout_badge_max = 1
  assign flair_variant_setting = "none"
  assign flair_layout_css = "line-height: 0;margin: 10px 0;"
else
  assign flair_layout_badge_max = flair_layout_config.badge_max | default: 1
  assign flair_variant_setting = flair_layout_config.variant_setting
  assign flair_layout_css = flair_layout_config.layout_css
endif

if flair_variant_setting == "none"
  assign flair_variant = blank
endif

if flair_variant == blank
  case flair_variant_setting
  when "selected_available"
    assign flair_variant = product.selected_or_first_available_variant
  when "selected_first"
    assign flair_variant = product.selected_variant
    if flair_variant == blank
      assign flair_variant = product.variants.first
    endif
  when "selected"
    assign flair_variant = product.selected_variant
  endcase
endif

assign flair_badge_count = 0
assign flair_collection_id_string = product.collections | map: "id" | join: "|" | prepend: "|" | append: "|"
assign flair_customer_tag_string = customer.tags | join: "|" | prepend: "|" | append: "|" | downcase
assign flair_product_tag_string = product.tags | join: "|" | prepend: "|" | append: "|" | downcase
assign flair_inventory_total = 0
assign flair_inventory_can_sell_out = true
assign flair_price_min = product.price_min
assign flair_price_max = product.price_max
assign flair_sale_amount_min = 0
assign flair_sale_amount_max = 0
assign flair_sale_percent_min = 0
assign flair_sale_percent_max = 0

if flair_variant == blank
  for v in product.variants
    if v.inventory_management
      if v.inventory_policy == "continue"
        assign flair_inventory_can_sell_out = false
      endif
    else
      assign flair_inventory_can_sell_out = false
    endif
    if v.inventory_quantity > 0
      assign flair_inventory_total = flair_inventory_total | plus: v.inventory_quantity
    endif
    if v.price and v.compare_at_price
      assign flair_sale_amount = v.compare_at_price | minus: v.price
      if flair_sale_amount > 0
        assign flair_sale_percent = flair_sale_amount | times: 100.0 | divided_by: v.compare_at_price
        if flair_sale_amount_min == 0 or flair_sale_amount < flair_sale_amount_min
          assign flair_sale_amount_min = flair_sale_amount
        endif
        if flair_sale_amount_max == 0 or flair_sale_amount > flair_sale_amount_max
          assign flair_sale_amount_max = flair_sale_amount
        endif
        if flair_sale_percent_min == 0 or flair_sale_percent < flair_sale_percent_min
          assign flair_sale_percent_min = flair_sale_percent | round: 2
        endif
        if flair_sale_percent_max == 0 or flair_sale_percent > flair_sale_percent_max
          assign flair_sale_percent_max = flair_sale_percent | round: 2
        endif
      endif
    endif
  endfor
else
  if flair_variant.inventory_management
    if flair_variant.inventory_policy == "continue"
      assign flair_inventory_can_sell_out = false
    endif
  else
    assign flair_inventory_can_sell_out = false
  endif
  assign flair_inventory_total = flair_variant.inventory_quantity
  if flair_inventory_total < 0
    assign flair_inventory_total = 0
  endif
  assign flair_price_min = flair_variant.price
  assign flair_price_max = flair_variant.price
  if flair_variant.price and flair_variant.compare_at_price
    assign flair_sale_amount = flair_variant.compare_at_price | minus: flair_variant.price
    if flair_sale_amount > 0
      assign flair_sale_percent = flair_sale_amount | times: 100.0 | divided_by: flair_variant.compare_at_price
      if flair_sale_amount_min == 0 or flair_sale_amount < flair_sale_amount_min
        assign flair_sale_amount_min = flair_sale_amount
      endif
      if flair_sale_amount_max == 0 or flair_sale_amount > flair_sale_amount_max
        assign flair_sale_amount_max = flair_sale_amount
      endif
      if flair_sale_percent_min == 0 or flair_sale_percent < flair_sale_percent_min
        assign flair_sale_percent_min = flair_sale_percent | round: 2
      endif
      if flair_sale_percent_max == 0 or flair_sale_percent > flair_sale_percent_max
        assign flair_sale_percent_max = flair_sale_percent | round: 2
      endif
    endif
  endif
endif
assign flair_mfs = shop.metafields["flair-badges"]
for flair_mf_key in flair_config.badge_metafield_keys
  for flair_badge in flair_mfs[flair_mf_key]
    if flair_badge_count >= flair_layout_badge_max
      break
    endif

    if flair_layout_config.is_filtered
      unless flair_badge.layout_names contains flair_layout_config.name
        continue
      endunless
    endif

    if flair_badge.status == "scheduled"
      assign flair_now_seconds = "now" | date: "%s" | plus: 0
      assign flair_is_published = false
      assign flair_publish_seconds = flair_badge.published_at_epoch | plus: 0
      assign flair_unpublish_seconds = flair_badge.unpublished_at_epoch | plus: 0
      if flair_publish_seconds == 0 or flair_now_seconds >= flair_publish_seconds
        if flair_unpublish_seconds == 0 or flair_now_seconds < flair_unpublish_seconds
          assign flair_is_published = true
        endif
      endif
      unless flair_is_published
        continue
      endunless
    endif

    assign flair_all_rule_results = ""
    for flair_rule in flair_badge.rules
      assign flair_rule_result = false
      case flair_rule.rule_type
      when "collection"
        assign _flair_rule_ids = flair_rule.collections | map: "id"
        for _rule_id in _flair_rule_ids
          case flair_rule.match_type
          when "collection"
            assign _collection_id_s = collection.id | append: ""
            assign _rule_id_s = _rule_id | append: ""
            if _collection_id_s == _rule_id_s
              assign flair_rule_result = true
              break
            endif
          else
            assign _rule_id_match = _rule_id | prepend: "|" | append: "|"
            if flair_collection_id_string contains _rule_id_match
              assign flair_rule_result = true
              break
            endif
          endcase
        endfor
        if flair_rule.operator == "neq"
          if flair_rule_result
            assign flair_rule_result = false
          else
            assign flair_rule_result = true
          endif
        endif
      when "create_date"
        assign _product_age_seconds = product.created_at | date: "%s"
        assign _product_age_seconds = "now" | date: "%s" | minus: _product_age_seconds
        assign _flair_rule_seconds = flair_rule.create_days | times: 60 | times: 60 | times: 24
        if _product_age_seconds > 0 and _product_age_seconds <= _flair_rule_seconds
          assign flair_rule_result = true
        endif
      when "customer_behavior"
        case flair_rule.behavior_type
        when "spend_total"
          assign _flair_spend_total = flair_rule.spend_total | times: 100.0
          if flair_rule.operator == "lte" and customer.total_spent <= _flair_spend_total
            assign flair_rule_result = true
          elsif flair_rule.operator == "gte" and customer.total_spent >= _flair_spend_total
            assign flair_rule_result = true
          endif
        when "order_count"
          if flair_rule.operator == "lte"
            if customer.orders_count <= flair_rule.order_count
              assign flair_rule_result = true
            endif
          elsif flair_rule.operator == "gte"
            if customer.orders_count >= flair_rule.order_count
              assign flair_rule_result = true
            endif
          endif
        endcase
      when "company_name"
        assign _flair_company = customer.current_company.name | prepend: "|" | append: "|" | downcase
        assign _flair_values = flair_rule.values | join: "|" | prepend: "|" | append: "|" | downcase
        if _flair_values contains _flair_company
          assign flair_rule_result = true
        endif
        if flair_rule.operator == "neq"
          if flair_rule_result
            assign flair_rule_result = false
          else
            assign flair_rule_result = true
          endif
        endif
      when "customer_tag"
        for item in flair_rule.tags
          assign _flair_tag = item | prepend: "|" | append: "|" | downcase
          if flair_customer_tag_string contains _flair_tag
            assign flair_rule_result = true
            break
          endif
        endfor
        if flair_rule.operator == "neq"
          if flair_rule_result
            assign flair_rule_result = false
          else
            assign flair_rule_result = true
          endif
        endif
      when "customer_type"
        case flair_rule.value
        when "none"
          if customer == blank
            assign flair_rule_result = true
          endif
        when "consumer"
          if customer and customer.b2b? != true
            assign flair_rule_result = true
          endif
        when "business"
          if customer.b2b?
            assign flair_rule_result = true
          endif
        endcase
      when "inventory"
        assign _flair_min = blank
        assign _flair_max = blank
        case flair_rule.inventory_type
        when "in_stock"
          assign _flair_min = 1
        when "out_of_stock"
          assign _flair_max = 0
        else
          assign _flair_min = flair_rule.inventory_quantity_min | plus: 0
          assign _flair_max = flair_rule.inventory_quantity | plus: 0
        endcase
        if _flair_min == blank or flair_inventory_total >= _flair_min
          if _flair_max == blank or flair_inventory_total <= _flair_max
            case flair_rule.inventory_sell_out
            when "sellout"
              if flair_inventory_can_sell_out
                assign flair_rule_result = true
              endif
            when "oversell"
              unless flair_inventory_can_sell_out
                assign flair_rule_result = true
              endunless
            else
              assign flair_rule_result = true
            endcase
          endif
        endif
      when "metafield"
        assign _flair_mf = blank
        if flair_rule.owner_type == "shop"
          assign _flair_mf = shop.metafields[flair_rule.namespace][flair_rule.key]
        elsif flair_rule.owner_type == "product"
          assign _flair_mf = product.metafields[flair_rule.namespace][flair_rule.key]
        elsif flair_rule.owner_type == "variant" and flair_variant
          assign _flair_mf = flair_variant.metafields[flair_rule.namespace][flair_rule.key]
        endif

        if flair_rule.operator == "exists" and _flair_mf and _flair_mf != blank
          assign flair_rule_result = true
        else
          assign _flair_mf_type_prefix = _flair_mf.type | slice: 0, 5
          if _flair_mf_type_prefix == "list."
            for val in flair_rule.values
              assign _flair_match = _flair_mf | where: "value", val
              if _flair_match
                assign flair_rule_result = true
                break
              endif
            endfor
          else
            for val in flair_rule.values
              assign val = val | append: "" | strip
              assign _flair_mf_val = _flair_mf.value | default: _flair_mf | append: "" | strip
              if _flair_mf_val == val
                assign flair_rule_result = true
                break
              endif
            endfor
          endif

          if flair_rule.operator == "neq"
            if flair_rule_result
              assign flair_rule_result = false
            else
              assign flair_rule_result = true
            endif
          endif
        endif
      when "page_type"
        assign _flair_page_types = flair_rule.page_types | map: "id"
        if _flair_page_types contains flair_page_type
          assign flair_rule_result = true
        endif
        if flair_rule.operator == "neq"
          if flair_rule_result
            assign flair_rule_result = false
          else
            assign flair_rule_result = true
          endif
        endif
      when "price"
        assign _flair_amount = flair_rule.amount | times: 100.0
        if flair_rule.operator == "lte" and flair_price_min <= _flair_amount
          assign flair_rule_result = true
        elsif flair_rule.operator == "gte" and flair_price_max >= _flair_amount
          assign flair_rule_result = true
        endif
      when "product"
        assign _flair_rule_ids = flair_rule.products | map: "id" | join: "|" | prepend: "|" | append: "|"
        assign _product_id_match = product.id | prepend: "|" | append: "|"
        if _flair_rule_ids contains _product_id_match
          assign flair_rule_result = true
        endif
        if flair_rule.operator == "neq"
          if flair_rule_result
            assign flair_rule_result = false
          else
            assign flair_rule_result = true
          endif
        endif
      when "product_option"
        assign _flair_option_names = product.options | join: "|" | prepend: "|" | append: "|" | downcase
        assign _flair_option_values = blank
        if flair_variant == blank
          assign _flair_option_values = product.options_with_values | map: "values" | uniq | join: "|" | prepend: "|" | append: "|" | downcase
        else
          assign _flair_option_values = flair_variant.options | uniq | join: "|" | prepend: "|" | append: "|" | downcase
        endif
        assign _flair_name_result = false
        assign _flair_value_result = false
        if flair_rule.name_operator == "any"
          assign _flair_name_result = true
        else
          for item in flair_rule.names
            assign _flair_name = item | prepend: "|" | append: "|" | downcase
            if _flair_option_names contains _flair_name
              assign _flair_name_result = true
              break
            endif
          endfor
          if flair_rule.name_operator == "neq"
            if _flair_name_result
              assign _flair_name_result = false
            else
              assign _flair_name_result = true
            endif
          endif
        endif
        if flair_rule.operator == "any"
          assign _flair_value_result = true
        else
          for item in flair_rule.values
            assign _flair_value = item | prepend: "|" | append: "|" | downcase
            if _flair_option_values contains _flair_value
              assign _flair_value_result = true
              break
            endif
          endfor
          if flair_rule.operator == "neq"
            if _flair_value_result
              assign _flair_value_result = false
            else
              assign _flair_value_result = true
            endif
          endif
        endif
        if _flair_name_result and _flair_value_result
          assign flair_rule_result = true
        endif
      when "sale_price"
        assign _flair_match = true
        case flair_rule.match_type
        when "single"
          if flair_sale_amount_min != flair_sale_amount_max
            assign _flair_match = false
          endif
        when "multiple"
          if flair_sale_amount_min == flair_sale_amount_max
            assign _flair_match = false
          endif
        endcase
        if _flair_match
          if flair_rule.operator == "lte" and flair_sale_percent_min <= flair_rule.sale_percent
            assign flair_rule_result = true
          elsif flair_rule.operator == "gte" and flair_sale_percent_max >= flair_rule.sale_percent
            assign flair_rule_result = true
          endif
        endif
      when "tag"
        for item in flair_rule.tags
          assign _flair_tag = item | prepend: "|" | append: "|" | downcase
          if flair_product_tag_string contains _flair_tag
            assign flair_rule_result = true
            break
          endif
        endfor
        if flair_rule.operator == "neq"
          if flair_rule_result
            assign flair_rule_result = false
          else
            assign flair_rule_result = true
          endif
        endif
      endcase
      if flair_rule_result
        assign flair_all_rule_results = flair_all_rule_results | append: "1"
      else
        assign flair_all_rule_results = flair_all_rule_results | append: "0"
      endif
    endfor

    assign flair_show_badge = false
    if flair_badge.rules_apply_to == "all"
      unless flair_all_rule_results contains "0"
        assign flair_show_badge = true
      endunless
    elsif flair_all_rule_results contains "1"
      assign flair_show_badge = true
    endif

    if flair_show_badge
      assign flair_badge_count = flair_badge_count | plus: 1
      capture "flair_badge_output"
        if flair_badge.css
          assign _css = flair_badge.css | replace: "${product_id}", product.id
          echo "<style>" | append: _css | append: "</style>"
        endif
        assign _content = flair_badge.content | replace: "${product_id}", product.id
        echo _content
      endcapture

      for item in flair_badge.dynamic_text_vars
        assign _flair_val = ""
        case item
        when "${company_name}"
          assign _flair_val = customer.current_company.name
        when "${customer_first_name}"
          assign _flair_val = customer.first_name
        when "${inventory_total}"
          assign _flair_val = flair_inventory_total
        when "${price_max}"
          assign _flair_val = flair_price_max | money_without_trailing_zeros
        when "${price_min}"
          assign _flair_val = flair_price_min | money_without_trailing_zeros
        when "${sale_amount_max}"
          assign _flair_val = flair_sale_amount_max | money_without_trailing_zeros
        when "${sale_amount_min}"
          assign _flair_val = flair_sale_amount_min | money_without_trailing_zeros
        when "${sale_percent_max}"
          assign _flair_val = flair_sale_percent_max | round
        when "${sale_percent_min}"
          assign _flair_val = flair_sale_percent_min | round
        else
          if item contains "${metafield."
            assign _flair_mf_parts = item | split: "."
            assign _flair_mf_owner = _flair_mf_parts[1]
            assign _flair_mf_ns = _flair_mf_parts[2] | strip
            assign _flair_mf_key = _flair_mf_parts[3] | split: "}" | first | strip
            if _flair_mf_owner == "shop"
              assign _flair_mf = shop.metafields[_flair_mf_ns][_flair_mf_key]
            elsif _flair_mf_owner == "product"
              assign _flair_mf = product.metafields[_flair_mf_ns][_flair_mf_key]
            elsif _flair_mf_owner == "variant" and flair_variant
              assign _flair_mf = flair_variant.metafields[_flair_mf_ns][_flair_mf_key]
            endif
            assign _flair_val = _flair_mf | metafield_text
          elsif item contains "_discount_percent_"
            assign _flair_price = flair_price_min
            if item contains "price_max"
              assign _flair_price = flair_price_max
            endif
            assign _flair_tmp = item | split: "_discount_percent_"
            assign _flair_tmp = _flair_tmp[1] | split: "}" | first | plus: 0
            assign _flair_percent = 100 | minus: _flair_tmp | divided_by: 100.0
            assign _flair_val = _flair_price | times: _flair_percent | round | money_without_trailing_zeros
          elsif item contains "_discount_amount_"
            assign _flair_price = flair_price_min
            if item contains "price_max"
              assign _flair_price = flair_price_max
            endif
            assign _flair_tmp = item | split: "_discount_amount_"
            assign _flair_tmp = _flair_tmp[1] | split: "}" | first | plus: 0 | times: 100
            assign _flair_val = _flair_price | minus: _flair_tmp
            if _flair_val < 0
              assign _flair_val = 0
            endif
            assign _flair_val = _flair_val | money_without_trailing_zeros
          endif
        endcase
        assign flair_badge_output = flair_badge_output | replace: item, _flair_val
      endfor

      assign flair_output = flair_output | append: flair_badge_output
    endif
  endfor
endfor
-%}
{%- liquid
if flair_layout != blank
  assign flair_layout_attr = 'data-layout="' | append: flair_layout | append: '"'
elsif flair_layout_config != blank
  assign flair_layout_attr = 'data-layout-auto="' | append: flair_layout_config.name | append: '"'
endif
-%}
<div class="flair-badge-layout" data-flair-product-badge data-product-id="{{ product.id }}" {{ flair_layout_attr }}{% if flair_output != "" %} style="{{ flair_layout_css }}"{% endif %}>
  {%- if flair_output != "" -%}{{ flair_output }}{%- endif -%}
</div>
{%- liquid
assign flair_layout = blank
assign flair_variant = blank
-%}
<!-- generated: {{ "now" | date: "%F %T %z" }} -->
